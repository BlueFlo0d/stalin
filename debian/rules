#!/usr/bin/make -f
# debian/rules file - for Stalin
# Copyright 1994,1995 by Ian Jackson
# Copyright 1998-2004 by Rob Browning

SHELL    := /bin/bash
quilt := QUILT_PATCHES=debian/patches quilt

upstream_archive := stalin_0.9+0.10alpha2.orig.tar.gz
upstream_archive_dir := stalin-0.10alpha2

srcname  := $(shell dpkg-parsechangelog | grep Source:)
srcname  := $(shell echo $(srcname) | perl -pe 's/^Source:\s+//o')

version  := $(shell dpkg-parsechangelog | grep Version:)
version  := $(shell echo $(version) | perl -pe 's/^Version:\s+//o')
upstream := $(shell echo $(version) | perl -pe 's/-[^-]*$$//o')
deb_rev  := $(shell echo $(version) | perl -pe 's/.*-//o')

target    := $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)

define patch
  $(quilt) push -a
endef

define unpatch
  #   now unpatch
  test -z "$$($(quilt) applied)" || $(quilt) pop -a
  rm -f debian/stamp/patch
  rm -rf .pc
endef

define checkdir
  dpkg-parsechangelog > /dev/null
  test -f debian/stalin-wrapper
  @if ! test -f stalin.sc; \
  then \
    echo; \
    echo -n "The upstream source does not appear to be available."; \
    echo "  Please put the contents"; \
    echo -n "of $(upstream_archive) into the"; \
    echo " current directory."; \
    echo; \
    false; \
  fi
endef

define cleanup_all
  $(MAKE) clean
  rm -f stalin-ARM.c stalin-M68K.c stalin-PowerPC.c stalin-SPARC.c
  $(unpatch)
  rm -rf debian/stamp debian/substvars
  find -name '*~' -o -name core | xargs --no-run-if-empty rm -f
  rm -rf debian/tmp debian/files*
  rm -rf $(DEB_TRASH)
endef

define run_tests
  rm -rf debian/tmp-test
  mkdir debian/tmp-test
  echo '(display "hello") (newline)' > debian/tmp-test/hello.scm
  cd debian/tmp-test && $(CURDIR)/stalin -On hello.scm
  test -x debian/tmp-test/hello
  test $$(debian/tmp-test/hello) = "hello"
endef

DEB_TRASH += debian/tmp-test


.PHONY: check-diff
check-diff:
	$(checkdir)
	$(cleanup_all)
	@test -r ../$(upstream_archive)
	@rm -rf debian/tmp-diff && mkdir debian/tmp-diff
	@cd debian/tmp-diff && tar xzpSf ../../../$(upstream_archive)
	@cd debian/tmp-diff && mv $(upstream_archive_dir) orig

	mkdir debian/tmp-diff/new
	tar cpf - --exclude './debian' --exclude './.pc' . \
	  | (cd debian/tmp-diff/new && tar xpf -)

	@echo
	@echo "########################################"
	@echo "### Diffs outside ./debian"
	@cd debian/tmp-diff && diff -ruN orig new
	@echo "########################################"
	@echo "### Empty file list differences"
	@diff -u \
	  <(cd debian/tmp-diff/orig && find -size 0) \
	  <(cd debian/tmp-diff/new && find -size 0) \
	    > debian/tmp-diff/empty-files.diff || test $$? -eq 1
	@cat debian/tmp-diff/empty-files.diff
	@test ! -s debian/tmp-diff/empty-files.diff || false
	@echo "########################################"
	@rm -rf debian/tmp-diff

DEB_TRASH += debian/tmp-diff

check-auto-parse:
	@echo "     srcname:" $(srcname)
	@echo "     version:" $(version)
	@echo "    upstream:" $(upstream)
	@echo "     deb_rev:" $(deb_rev)

buildpackage:
	${checkdir}
	dpkg-buildpackage -D -us -uc -rfakeroot -i'\.hg|\.pc'
.PHONY: buildpackage

debian/stamp/patch:
	$(checkdir)
	$(patch)
	mkdir -p $(dir $@) && touch $@

build: debian/stamp/build
debian/stamp/build: debian/stamp/patch
	$(checkdir)
        # these architectures are equivalent, so we do this to save a LOT of space
	ln -sf stalin-IA32.c stalin-ARM.c
	ln -sf stalin-IA32.c stalin-M68K.c
	ln -sf stalin-IA32.c stalin-PowerPC.c
        # even though indlude/stalin.architectures doesn't match, the generated
        # source (cross-compiled via gluck) does, so this should be OK for SPARC.
	ln -sf stalin-IA32.c stalin-SPARC.c
	CC=gcc-3.4 ./build
	CC=gcc-3.4 ./build-gl-fpi
	$(run_tests)
	mkdir -p $(dir $@) && touch $@
.PHONY: build

clean:
	$(checkdir)
	$(cleanup_all)
.PHONY: clean

binary-indep:	checkroot build
	$(checkdir)
        # There are no architecture-independent files to be uploaded
        # generated by this package.  If there were any they would be
        # made here.
.PHONY: binary-indep

binary-arch:	checkroot build
	$(checkdir)
	rm -rf debian/tmp
	install -d debian/tmp

        # Binaries
	install -d debian/tmp/usr/bin
	cp debian/stalin-wrapper debian/tmp/usr/bin/stalin

        # libs (some of these should be in share, but stalin doesn't make the
        # distinction ATM)
	install -d debian/tmp/usr/lib/stalin
	cp -r include/* debian/tmp/usr/lib/stalin
	install -s include/stalin debian/tmp/usr/lib/stalin/


        # manpages
	install -d debian/tmp/usr/share/man/man1
	cp stalin.1 debian/tmp/usr/share/man/man1
	find debian/tmp/usr/share/man -type f | xargs gzip -9v

        # docs
	install -d debian/tmp/usr/share/doc/$(srcname)
	install README ANNOUNCEMENT stalin.el debian/tmp/usr/share/doc/$(srcname)
	cp debian/changelog debian/tmp/usr/share/doc/$(srcname)/changelog.Debian
	cp -a benchmarks debian/tmp/usr/share/doc/$(srcname)
	find debian/tmp/usr/share/doc/$(srcname) -type f | xargs gzip -9v
	cp debian/copyright debian/tmp/usr/share/doc/$(srcname)

        # Mangle permissions to conform.
	chown -R root.root debian/tmp
	find debian/tmp -type d | xargs chmod 755
	find debian/tmp -not -type d -a -not -type l | xargs chmod 644
	chmod 755 debian/tmp/usr/bin/*
	chmod 755 debian/tmp/usr/lib/stalin/stalin
	chmod 755 debian/tmp/usr/lib/stalin/stalin-architecture-name

        # control scripts	
	install -d debian/tmp/DEBIAN
	install debian/prerm debian/tmp/DEBIAN/
	chmod 755 debian/prerm

        # Final steps...
	dpkg-shlibdeps debian/tmp/usr/lib/stalin/stalin
	dpkg-gencontrol -pstalin -isp
	dpkg --build debian/tmp ..
.PHONY: binary-arch

# Below here is fairly generic really

binary:		binary-indep binary-arch
.PHONY: binary

source diff:
	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

checkroot:
	$(checkdir)
	test root = "`whoami`"
.PHONY: checkroot

# Local variables:
# mode: makefile
# End:
